function Reservation(){
	BaseFunc.call(this);
	var self = this;


	//科室管理
    this.department_manager = function(para){
		var self = this;
		
		this.dep_checkdate();

			
		var departtable=$("#departmentmanage").DataTable({
			
			bStateSave:false,
			serverSide: false,
			processing: true,
			searching: true,
			//data:retd.rows,
			ajax:{
				'url':'/controller/?controller=DepartmentManager&method=query',
				//'dataSrc': 'data',
				'type':'POST',				
				'dataType':'json',
				'dataSrc': function(json){
					
					return json.data;
					
				}
				
			},
			aoColumnDefs : [
				{sClass:'text-l',aTargets:[2]}
							],

			columns: [
			            {
			            	data : 'id',
			            	render : function (id, type, row) {
			            		return '<input type="checkbox" name="tr_'+id+'" id="tr_'+id+'" value="'+id+'">';
			            	},
			            	name: 'xuanze',
			            	orderable:false
			            },
			            { data: 'id'	
			            	},
			            { data: 'name',name:'name'},
			            { data: 'num',name:'num'},
			            { data: 'resernum',name:'resernum'},

			            {
						  
						  render : function(data, type, row){
							  var str = '';
							  str += '<a style="text-decoration:none" dataid="'+row.id+'" class="depedit" href="javascript:;" title="编辑"><i class="Hui-iconfont">&#xe6df;</i></a> <a style="text-decoration:none" class="ml-5 docman"  dataid="'+row.id+'" href="javascript:;" title="科室医生管理"><i class="Hui-iconfont">&#xe62b;</i></a> <a style="text-decoration:none" class="ml-5 delitem" dataid="'+row.id+'" title="删除"><i class="Hui-iconfont">&#xe6e2;</i></a>';
					    	  return str;
						  },
						  orderable:false
						 }
			        ]


		
		});
		
		$('body').on('click','.depedit', function () {
			var id=$(this).attr('dataid');
			layer.open({
				type:2,	
				area: ['900px', '500px'],
			    content: 'edit-department.html',
			    success: function(layero,index){
			        layer.setTop(layero); 
			        var body = layer.getChildFrame('body', index);
			        var iframeWin = window[layero.find('iframe')[0]['name']];
			       // $(window.frames["iframeSon"].document).find(":text");
			        //console.log(body.html());
			      iframeWin.deparedit.add_department({id:id});//这里
			    }
			});
			
		});
		
		$('body').on('click','.reflash',function(){
			troad('#departmentmanage');	
			this.dep_checkdate();
		});
		
		$('body').on('click','.delitem',function(){
			var id=$(this).attr('dataid');
			layer.open({
				type:1,	
				area: ['900px', '400px'],
			    content: '<p>确定要删除吗?</p>',
			    btn: ['确定', '取消'],
			    yes:function(index,layero){
			    	self.cmd(gHttp,{controller:'DepartmentManager',method:'del',id:id},function(result1){
						if(result1.statu){
							layer.msg('删除成功!',{icon:1});
							troad('#departmentmanage');	
							checkdepdate();
							
						}else{
							layer.msg(result1.msg,{icon:2});							
						}
						return false;
					});
			    	
			    	
			    },
			    cancel:function(index,layero){
			    	layer.close(index);
			    }
//			    success: function(layero,index){
//			        layer.setTop(layero); 
//			        var body = layer.getChildFrame('body', index);
//			        var iframeWin = window[layero.find('iframe')[0]['name']];
//			       // $(window.frames["iframeSon"].document).find(":text");
//			        //console.log(body.html());
//			      iframeWin.doctortodepart.doctortodepartment({department_id:id});//这里
//			    }
			});
			
		});
		
		$('body').on('click','.docman', function () {
			var id=$(this).attr('dataid');		
			
			layer.open({
				type:2,	
				area: ['900px', '400px'],
			    content: 'doctor-to-department.html',
			    success: function(layero,index){
			        layer.setTop(layero); 
			        var body = layer.getChildFrame('body', index);
			        var iframeWin = window[layero.find('iframe')[0]['name']];
			       // $(window.frames["iframeSon"].document).find(":text");
			        //console.log(body.html());
			      iframeWin.doctortodepart.doctortodepartment({department_id:id});//这里
			    }
			});
			
		});
		

		
		
		
		
		
		
		//});
		$('body').on('click','#add_dep', function () {
			//var id=$(this).attr('dataid');
			
			
			layer.open({
				type:2,	
				title:'编辑科室信息',
				area: ['800px', '500px'],
			    content: 'edit-department.html',
			    success: function(layero,index){
			        layer.setTop(layero); 
			        var body = layer.getChildFrame('body', index);
			        var iframeWin = window[layero.find('iframe')[0]['name']];			       
			        iframeWin.deparedit.add_department();//这里
			    }
			});
			
		});
		
		$('body').on("click",'#imp',function(){
			
			self.cmd(gHttp,{controller:'DepartmentManager',method:'importdate'},function(ret){
				if(ret.stutes){
					//$('#grid').grid('reload');
					layer.msg('数据已经存在无需导入!');
					$('#imp').hide();
					$('#exp').show();
					
				}else{
					layer.msg('数据已经存在无需导入!');
					$('#imp').hide();
					troad('#departmentmanage');					
					//$('#message').message('导入数据成功!',function(){
						//$('#grid').grid('reload');
					//});
				}
			});
		});
		
		$('body').on("click",'#exp',function(){
			
			self.cmd(gHttp,{controller:'DepartmentManager',method:'exportdate'},function(ret){
				if(ret.stutes){
					var html='';
					html+='<div class="row cl text-c pd-10">数据己准备完毕...</div><div class="row cl"><div class="col-12 text-c"><a href="'+ret.url+'" class="btn btn-success radius"><i class="Hui-iconfont">&#xe641;</i> 开始下载</a></div></div>';
					layer.open({
						type:1,							
					    content: html,
					    title:'下载数据',
						area: ['252px', '120px'],
					});
					
				
					
				}else{					
					layer.alert('导出数据失败!请重试',{icon:2}); 
				}
			});	
			

		});
		
		
		$('body').on('click','#submitbutton', function () {
			var table = $('#departmentmanage').DataTable();
			var name=$.trim($('#searchkey').val());
			 table.columns(2).search(name).draw();			
		});
		$('#searchkey').on( 'keyup click', function () {   // for text boxes
			var table = $('#departmentmanage').DataTable();
		    var v =$(this).val();  // getting search input value
		    table.columns(2).search(v).draw();
		} );
		
		$('body').on('click', '#datadel',function() {
			//chooseall('reservationtable');
			var data = chooseall('#departmentmanage');
			var ids = [];
			//console.log(data);
			if(data.length <= 0){
				layer.msg('请选择需要删除的选项!', function(){					
				}); 
			}else{
				
				layer.confirm('真的要删除么？', {icon: 3, title:'提示'}, function(index){
				  
					$.each(data,function(i,obj){
						ids[i] = obj.value;
					});	
				    layer.close(index);	
					self.cmd(gHttp,{controller:'DepartmentManager',method:'del',id:ids},function(ret){
						if(ret.statu){
							
							layer.msg('删除成功!', function(){					
							}); 
							troad('#departmentmanage');
							$('.firstone').attr('checked', false);

						}else{
							
							layer.msg(ret.msg, function(){					
							}); 
							
						}
					});
				});
				
			}
			return false; 
			

			 
			});
		

	}
    
    this.dep_checkdate=function(){
		self.cmd(gHttp,{controller:'DepartmentManager',method:'checkdate'},function(ret){
			if(ret.stutes){

				$('#exp').show();
				$('#imp').hide();

			}else{
				$('#imp').show();
				$('#exp').hide();

				
			}
		});
    }
	//编辑预约科室
    this.add_department=function(para){
    	var self=this;
    	if(para==undefined){    		
				/**new*/
				$('body').on('click','.adddepss', function () {
					var post={controller:'DepartmentManager',method:'add'};
				//保存
					$('#formEdit').checkAndSubmit('save', post,function(ret){
						if(ret.statu){
							var url=parent.location.href;
							parent.location.replace(url);
							parent.layer.msg('操作成功!',{icon: 1});	
							layer_close();
						}else{
							parent.layer.alert(ret.msg,{icon:2});
						}
		
						return false;
					});
					
					$('#formEdit').submit();
    			/**new over*/													
				});				
    		
    	}else{
    		self.cmd(gHttp,{controller:'DepartmentManager',method:'get',id:para.id},function(re){
    			if(re.statu){
    				$('#title').val(re.data.name);
    				$('#smalldescript').html(re.data.smalldescript);    				  				
    				editor.ready(function() {
    					editor.setContent(re.data.fulldescript);
    				});    				
    	    		$('body').on('click','.adddepss', function () {
    	    			var fulldescript=editor.getContent();
    	    			var name=$('#title').val();
    	    			var descript=$('#smalldescript').val();   
						/**new*/
						var post={controller:'DepartmentManager',method:'edit',name:name,smalldescript:descript,fulldescript:fulldescript,id:para.id};
						//保存
						$('#formEdit').checkAndSubmit('save', post,function(ret){
							if(ret.statu){
								var url=parent.location.href;
								parent.location.replace(url);
								parent.layer.msg('操作成功!',{icon: 1});	
								layer_close();
							}else{
								parent.layer.alert(ret.msg,{icon:2});
							}
			
							return false;
						});
						
						$('#formEdit').submit();
						/**new over*/
    	    			});
    				
    			}else{
					layer.msg(re.msg,{icon:2}); 
    			}
    		}); 
    		
    		
    	}
    }
    this.doctortodepartment=function(para){
    	var self = this;
    	if(para!=undefined){    		
			var t=$("#doctortodepartment").DataTable({				
				bStateSave:false,
				serverSide: false,
				processing: true,
				ajax:{
					'url':'/controller/?controller=DoctorManager&method=query',
					//'dataSrc': 'data',
					'type':'POST',
					'data': {												
						'departmentmanager_id':para.department_id,
							
					},
					'dataType':'json',
					'dataSrc': function(json){

						return json.data;
						
					}			
				},
				
				order: [[ 1, "desc" ]],
				columns: [
				            {
				            	data : 'id',
				            	render : function (id, type, row) {
				            		return '<input type="checkbox" name="tr_'+id+'" id="tr_'+id+'" value="'+id+'">';
				            	},
				            	name: 'xuanze',
				            	orderable:false
				            },
                            { data: 'id',name:'id' },
				            { data: 'name',name:'name' },
				            { data: 'pic',name:'pic',
				            	render:function(id, type, row){
				            		if(id!=""){
				            		var picth='';
				            		picth +='<img width="90px" src="/upload/'+row.pic+'" />';
				            		return picth;
				            		}else{
				            			return null;
				            		}
				            	},
				            	orderable:false
				            	},
				            { data: 'content',name:'content',
				            	render:function(id, type, row){
				            		var contents=id.substring(0,30);
				            		return contents;
				            	}
				            	},
				            { data : 'id',
							  render : function(id, type, row){
								
								  var str = '';
								  str += '<a title="删除" class="ml-5 deldo" dataid="'+row.id+'" style="text-decoration:none"><i class="Hui-iconfont"></i></a>';
						    	  return str;
							  },
							  orderable:false
							 }
				        ]

			
			});
			

			
			
    		
    	}
    	
    	$('body').on('click','.deldo',function(){
    		
    		var id=$(this).attr('dataid');
    		self.cmd(gHttp,{controller:'DoctorManager',method:'change_relation',id:id},function(re){
    			if(re.statu){
    				layer.msg('删除成功');
    				troad('#doctortodepartment');
    				
    				
    			}else{
					layer.msg(re.msg, function(){
						
					}); 
    			}
    			
    		});
    		
    	});
    	
    	$('body').on('click','#newdoctor',function(){
    		
			self.cmd(gHttp,{controller:'DoctorManager',method:'get_otherdoctor',departmentmanager_id:para.department_id},function(re){
				if(re.statu){
					var str='';
					$.each(re.data, function(idx, obj) {
						str+='<li class="clinic_item"><input type="checkbox" value="'+obj.id+'" name="doctorother" >&nbsp;'+obj.name+'</li>'; 
					});															
					$('#doctor_list').html(str);
				}
				
			});
    	})
    	
		$('body').on('click','#trushmut',function(){
			var data = chooseall('#doctortodepartment');
			var ids = [];
			//console.log(data);
			if(data.length <= 0){
				layer.msg('请选择需要删除的选项!', function(){					
				}); 
			}else{
				
				layer.confirm('真的要删除么？', {icon: 3, title:'提示'}, function(index){
				  
					$.each(data,function(i,obj){
						ids[i] = obj.value;
					});	
				    layer.close(index);
				



					self.cmd(gHttp,{controller:'DoctorManager',method:'change_relation',id:ids},function(ret){
						if(ret.statu){
							
							layer.msg('删除成功!', function(){					
							}); 
							troad('#doctortodepartment');
							$('.firstone').attr('checked', false);

						}else{
							
							layer.msg(ret.msg, function(){					
							}); 
							
						}
					});
				});
				
			}
			return false; 
			
			
		});
    	
		$('#keywordin, #searchbu').on( 'keyup click change', function () {   // for text boxes

			var name=$.trim($('#keywordin').val()); // getting search input value
			self.cmd(gHttp,{controller:'DoctorManager',method:'get_otherdoctor',departmentmanager_id:para.department_id,name:name},function(re){
				if(re.statu){
					var str='';
					$.each(re.data, function(idx, obj) {
						str+='<li class="clinic_item"><input type="checkbox" value="'+obj.id+'" calss="doctorother" >&nbsp;'+obj.name+'</li>'; 
					});															
					$('#doctor_list').html(str);
				}
				
			});
			

		} );
		
		$('body').on('click','#chooseitem',function(){
			var check_val=[];
		    
		    var tbody=$('#doctor_list');
		  
		    var  checks=tbody.find('input[type="checkbox"]');
		    for(var i=0; i<checks.length;i++){
		    	if(checks[i].checked){
		    	check_val.push(checks[i]);
		    	}
		    }
		    //console.log(checks);
		    ids=[];
		    $.each(check_val,function(i,obj){
				ids[i] = obj.value;
			});	
		    
		    self.cmd(gHttp,{controller:'DoctorManager',method:'changedepartment',departmentmanager_id:para.department_id,id:ids},function(re){
		    	if(re.stute){
		    		layer.msg('添加成功');
    				
		    		self.cmd(gHttp,{controller:'DoctorManager',method:'get_otherdoctor',departmentmanager_id:para.department_id},function(res){
						if(res.statu){
							var strs='';
							$.each(res.data, function(idx, obj) {
								strs+='<li class="clinic_item"><input type="checkbox" value="'+obj.id+'" calss="doctorother" >&nbsp;'+obj.name+'</li>'; 
							});															
							$('#doctor_list').html(strs);
							
						}
						
					});
		    		troad('#doctortodepartment');
		    		
		    	}else{
					layer.msg(ret.msg, function(){					
					}); 
		    	}
		    	
		   });
		    
		})
    	
    	
    	
    }

	
	
	this.doctorEdit = function(para){
		var self = this;
		//这里修改了#doctor为#container
		$('#container').tpl('reser_manage/doctor_edit',function(){
			Back.PushChild('doctorEdit',para);
			json.getImgSize('doctorsize');
			var html = '';
			
			if(para.departments!=undefined){
			html = '<option value="">请选择</option>';
			//关联科室
			$.each(para.departments,function(i,obj){
				html += '<option value="'+obj.id+'">'+obj.name+'</option>';
			});
			
			$('#department_id').html(html);
			
			if(para.department_id!=undefined){
				
				$('#department_id').children("option").each(function(){  
		               var dotemp_value = $(this).val();
		              if(dotemp_value == para.department_id){
		            	 //console.log(retdts.data.doctor_id);
		                    $(this).attr("selected","selected");  
		              }  
		              
		         });
				var str="";
				dd.cmd({controller:'Disease',method:'getByDepartmentID',department_id:para.department_id},function(val){
					$.each(val.data,function(i,obj){
						var check = '';
						$.each(val,function(o,b){
							if(b.disease_id == obj.id){
								check = 'checked';
								return false;
							}
						});
						str += '<input '+check+' class="check" type="checkbox" name="disease_id['+i+']" value="'+obj.id+'">'+obj.name+'&nbsp;&nbsp;&nbsp;';
					});
					$('#disease_id').html(str);
				});
				
			}
			}else{
				$('#department').html("");
				$('#department').hide();
				$('#goodat').hide();
			}
			//获取推荐位相关

			var post = {};		
			if(para.method == 'edit'){
				dd.cmd({controller:'DoctorManager',method:'get',id:para.id},function(ret){
					if(ret.statu){
						$('#doctor_edit').frmFill('',ret.data);
						//加载富文本编辑器
						$('#editor').ckeditor({width:800,height:370},function(){
							$('.cke_toolbox').append('<span class="cke_toolbar"><span class="cke_combo_button"><div style="margin-top:3px;"><a style="color:#666666" id="set" href="javascript:void(0)">网络相册</a></div></span</span>');
						});	
						if(ret.data.pic != ''){
							$('#img1').attr('src',ret.data.src1);
							json.setImgSize('doctorsize','#img1');
							$('#img1').before('<div class="del_div" style="margin-bottom:5px;"><a class="del_pic" flag=1 href="javascript:void(0)">删除图片</a></div>');
						}
						if(ret.data.certificate != ''){
							$('#img2').attr('src',ret.data.src2);
							$('#img2').before('<div class="del_div" style="margin-bottom:5px;"><a class="del_pic" flag=2 href="javascript:void(0)">删除图片</a></div>');
						}
						var str = '';
						dd.cmd({controller:'Disease',method:'getByDepartmentID',department_id:ret.data.department_id},function(val){
							$.each(val.data,function(i,obj){
								var check = '';
								$.each(ret.data.disease,function(o,b){
									if(b.disease_id == obj.id){
										check = 'checked';
										return false;
									}
								});
								str += '<input '+check+' class="check" type="checkbox" name="disease_id['+i+']" value="'+obj.id+'">'+obj.name+'&nbsp;&nbsp;&nbsp;';
							});
							$('#disease_id').html(str);
						});
						//动态加载已被选择的推荐位
						$('#recommendposition').find('input[name^=recommendposition]').each(function(){
							var checkbox = $(this);
							$.each(ret.data.recommend,function(i,obj){
								if(checkbox.val() == obj.recommendposition_id){
									checkbox.attr('checked','checked');
								}
							});
						});
					}else{
						$('#message').message(ret.msg);
					}
				});
				post = {controller:'DoctorManager',method:'edit',id:para.id};
			}else{
				//加载富文本编辑器
				$('#editor').ckeditor({width:800,height:370},function(){
					$('.cke_toolbox').append('<span class="cke_toolbar"><span class="cke_combo_button"><div style="margin-top:3px;"><a style="color:#666666" id="set" href="javascript:void(0)">网络相册</a></div></span</span>');
				});	
				post = {controller:'DoctorManager',method:'add'};
			}
			$('#save').click(function(){
				var flag = true;
//				$('.check').each(function(){
//					if($(this).attr('checked') != undefined){
//						flag = true;
//						return false;
//					}
//				});
				//if(flag){
				
					$('#doctor_edit').frmPost(post,function(ret){
						
						if(ret.statu){
							$('#message').message('操作成功!');
							if(para.department_id == undefined){
								self.doctor_manager();
							}else{
								self.doctor_manager({id:para.department_id});
							}
							
						}else{
							$('#message').message(ret.msg);
						}
						return false;
					});
//				}else{
//					$('#message').message('请选择关联的疾病信息!');
//					return false;
//				}
				
			});

			$('#doctor_edit').on('click','.del_pic',function(){
				var attr = $(this).attr('flag');
				$('#img'+attr).removeAttr('src');
				$('#pic_url'+attr).val('');
				$(this).remove();
			});

			//科室的变化
			$('#department_id').change(function(){
				var department_id = $(this).val();
				dd.cmd({controller:'Disease',method:'getByDepartmentID',department_id:department_id},function(ret){
					var str = '';
					$.each(ret.data,function(i,obj){
						str += '<input type="checkbox" class="check" name="disease_id['+i+']" value="'+obj.id+'">'+obj.name+'&nbsp;&nbsp;&nbsp;';
					});
					$('#disease_id').html(str);
				});
			});

			$('#pic1').uploadify({
				uploader : '../../controller/index.php?controller=Upload&method=uploadPic&dir=doctor', 
				swf : './public/js/uploadify.swf',
				fileTypeExts : '*.jpg;*.gif;*.png;*.jpeg',
				buttonText : '',
				width : 116,
				height : 30,
				onUploadSuccess : function(file,data,response){
					var obj = eval('['+data+']');
					$('#img1').prev('.del_div').remove();
					if(obj[0].result){
						$('#pic_url1').val(obj[0].url);
						$('#img1').attr('src',obj[0].path);
						json.setImgSize('doctorsize','#img1');
						$('#img1').before('<div class="del_div" style="margin-bottom:5px;"><a class="del_pic" flag=1 href="javascript:void(0)">删除图片</a></div>');
					}else{
                        $('#message').message('图片上传失败!请上传3M以下图片');
					}
				}
			});

			$('#pic2').uploadify({
				uploader : '../../controller/index.php?controller=Upload&method=uploadPic&dir=doctor',
				swf : './public/js/uploadify.swf',
				fileTypeExts : '*.jpg;*.gif;*.png;*.jpeg',
				buttonText : '',
				onUploadSuccess : function(file,data,response){
					var obj = eval('['+data+']');
					$('#img2').prev('.del_div').remove();
					if(obj[0].result){
						$('#pic_url2').val(obj[0].url);
						$('#img2').attr('src',obj[0].path);
                        json.setImgSize('doctorsize','#img2');
						$('#img2').before('<div class="del_div" style="margin-bottom:5px;"><a class="del_pic" flag=2 href="javascript:void(0)">删除图片</a></div>');
					}else{
						$('#message').message('图片上传失败!请上传3M以下图片');
					}
				}
			});

			//返回
			$('#back').click(function(){
				if(para.department_id == undefined){
					self.doctor_manager();
				}else{
					self.doctor_manager({id:para.department_id});
				}
				
			});

			//相册选择
			$('.select_xc').click(function(){
				var flag = $(this).attr('flag');
				$('#network_pic').pic_dialog('show');	
				$('#network_pic').pic_dialog({para:{controller:'NetworkPic',method:'getPic'},size:12,page:1,img:'#img'+flag,input:'#pic_url'+flag,message:'message',flag:flag});
				json.setImgSize('doctorsize','#img1');
			});
			
			//相册选择
			$('#doctor_edit').on('click','#set',function(){
				$('#network_pic').pic_dialog('show');
				$('#network_pic').pic_dialog({editor:'#editor',para:{controller:'NetworkPic',method:'getPic'},size:12,page:1,message:'message'});
			});			

			if(!$.browser.msie){
				$('#network_pic').picDrag('message');
			}

		});
	}
	
	//疾病管理
	this.disease = function(para){
		var self = this;
		$('#container').tpl('disease/list',function(ret){
			Back.PushChild('disease',para);
			if(para != undefined){
				//返回
				$('.toolBar').append('<li class=""><a href="javascript:void(0)" id="back" class="delete"><span>返回</span></a></li>');
				$('.toolBar').on('click','#back',function(){
					self.department();
				});
			}
			
			var post = {controller:'Disease',method:'query'};
			if(para != undefined){
				post.department_id = para.id;
			}
			
			$('#grid').grid({
				size : 10,
				para : post,
				check : true,
				order : true,
				field : [
					{text:'疾病名称',name:'name',width:80},
					{text:'文件存储目录',name:'url',width:95},
					{text:'所属科室',name:'department_name',width:80},
					{text:'所属疾病',name:'disease_name',width:80},
					{text:'疾病简介',name:'description'},
					{text:'操作',name:'id',width:162,
						render : function(value,rowData,rowIndex){
							var str='<a id="'+value+'" class="button btn_del" href="javascript:void(0)" style="margin-left:3px;"><span>删除</span></a>';
							str+='<a class="button btn_edit" id="'+value+'" href="javascript:void(0)" style="margin-left:8px;"><span>编辑</span></a>';
							str+='<a class="button btn_look" id="'+value+'" href="/controller/?controller=ViewHtml&method=disease&op=disease&id='+value+'" target="_blank" style="margin-left:8px;"><span>预览</span></a>';
							return str;
						}
					}
				]
			}).on('click','.btn_del',function(){
				if(window.confirm('真的要删除么,将同时删除其所有子疾病？')){
					var id = $(this).attr('id');
					dd.cmd({controller:'Disease',method:'del',id:id},function(ret){
						if(ret.statu){
							$('#message').message('删除成功!',function(){
								$('#grid').grid('reload');
							});
						}else{
							$('#message').message(ret.msg);
						}
						return false;
					});
				}
			}).on('click','.btn_edit',function(){
				$('#loading').addClass('loading');
				var id = $(this).attr('id');
				if(para != undefined){
					alert('1');
					self.diseaseEdit({id:id,department_id:para.id,method:'edit'});
				}else{
					alert('2');
					self.diseaseEdit({id:id,method:'edit'});
				}
				
			});	
			//获取科室信息
			dd.cmd({controller:'Department',method:'getDepartments'},function(ret){
				if(ret.statu){
					var str='<option value="">==全部==</option>';
					for (var i=0;i<ret.data.length;i++)
					{
						str +='<option value="'+ret.data[i].id+'">'+ret.data[i].name+'</option>';
					}
					$('#department_id').html(str);
				}else{
					$('#message').message(ret.msg);
				}
			
				return false;
			});
			//查询
			$('#qry').click(function(){
				var data = $('#frm_post').frmVal({});
				$('#grid').grid({qry_para:data});
			});

			//刷新
			$('#refresh').click(function(){
				if(para != undefined){
					self.disease({id:para.id});
				}else{
					$('#grid').grid('reload');
				}
				
			});
			
			//添加
			$('#add').click(function(){
				if(para != undefined){
					self.diseaseEdit({department_id:para.id,method:'add'});
				}else{
					
					self.diseaseEdit({method:'add'});
				}
				
			});

			//批量删除
			$('#del').click(function(){
				var data = $('#grid').grid('getRows');
				var ids = [];
				if(data.length <= 0){
					$('#message').message('请选择您要删除的选项!');
				}else{
					if(window.confirm('真的要删除么,将同时删除其所有子疾病？')){
						$.each(data,function(i,obj){
							ids[i] = obj.id;
						});	

						dd.cmd({controller:'Disease',method:'del',id:ids},function(ret){
							if(ret.statu){
								$('#message').message('删除成功!',function(){
									$('#grid').grid('reload');
								});
							}else{
								$('#message').message(ret.msg);
							}
						});
					}
					
				}
				return false; 
			});
			
		});
	}
	

	
	//疾病编辑
	this.diseaseEdit = function(para){
		var self = this;
		$('#disease').tpl('disease/edit',function(ret){
			Back.PushChild('diseaseEdit',para);
			json.getImgSize('diseasesize');
			var post = {};
			dd.cmd({controller:'Department',method:'getDepartments'},function(ret){
				if(ret.statu){
					var str='<option value="0">&nbsp;请选择科室&nbsp;</option>';
					var selected='';
					for (var i=0;i<ret.data.length;i++)
					{
						str +='<option value="'+ret.data[i].id+'" '+selected+'>'+ret.data[i].name+'</option>';
					}
					$('#department_id').html(str);
					if(para.method == 'edit'){
						dd.cmd({controller:'Disease',method:'get',id:para.id},function(ret){
							$('#disease_edit').frmFill('',ret.data);
							GetParList(ret.data.id);
							if(ret.data.pic != ''){
								$('#img').attr('src',ret.data.src);
								json.setImgSize('diseasesize');
								$('#img').before('<div class="del_div" style="margin-bottom:5px;"><a flag=1 class="del_pic" href="javascript:void(0)">删除图片</a></div>');
							}
							//加载富文本编辑器
							$('#editor').ckeditor({width:800,height:370},function(){
								$('.cke_toolbox').append('<span class="cke_toolbar"><span class="cke_combo_button"><div style="margin-top:3px;"><a style="color:#666666" id="set" href="javascript:void(0)">网络相册</a></div></span</span>');
							});								
                            var tplurl = $.trim(ret.data.tplurl);
                            if(tplurl != ''){
                                $('#a_filedelete').css('display','inline-block');
                                $('#btn_fileupload').attr('src','./public/img/cxsc.jpg');
                                $('#span_fileupload').html('已上传模版文件,模版路径：'+tplurl);
                            }
						});
						post = {controller:'Disease',method:'edit',id:para.id};
					}else{
						
						//加载富文本编辑器
						$('#editor').ckeditor({width:800,height:370},function(){
							$('.cke_toolbox').append('<span class="cke_toolbar"><span class="cke_combo_button"><div style="margin-top:3px;"><a style="color:#666666" id="set" href="javascript:void(0)">网络相册</a></div></span</span>');
						});							
						$('[name=name]').change(function(){
							var me = $(this);
							var val = me.val();
							dd.cmd({controller:'Pingyin',method:'conversion',data:val}, function(ret){
								$('#url').val(ret.data);
							});
						});
						post = {controller:'Disease',method:'add'};
					}
					
				}else{
					$('#message').message(ret.msg);
				}
				return false;
			});

			$('#file_upload').uploadify({
				uploader : '../../controller/index.php?controller=Upload&method=uploadPic&dir=disease', 
				swf : './public/js/uploadify.swf',
				fileTypeExts : '*.jpg;*.gif;*.png;*.jpeg',
				buttonText : '',
				width : 116,
				height : 30,
				onUploadSuccess : function(file,data,response){
					var obj = eval('['+data+']');
					$('#img').prev('.del_div').remove();
					if(obj[0].result){
						$('#pic').val(obj[0].url);
						$('#img').attr('src',obj[0].path);
						json.setImgSize('diseasesize');
						$('#img').before('<div class="del_div" style="margin-bottom:5px;"><a flag=1 class="del_pic" href="javascript:void(0)">删除图片</a></div>');
					}else{
                        $('#message').message('图片上传失败!请上传3M以下图片');

                    }
				}
			});

			$('#disease_edit').on('click','.del_pic',function(){
				$('#img').removeAttr('src');
				$('#pic').val('');
				$(this).remove();
			});

			//保存
			$('#save').click(function(){
				SetLayer();
				var department_id = $('select[name="department_id"]').val()*1;
				var layer_0       = $('#layer_0').val()*1;	
				//科室必须选择
				if(department_id==0){$('#message').message('请选择关联科室!');return false;}
				$('#disease_edit').frmPost(post,function(ret){
					if(ret.statu){
						$('#message').message('操作成功!');
						if(para.department_id != undefined){
							self.disease({id:para.department_id});
						}else{
							self.disease();
						}
						
					}else{
						$('#message').message(ret.msg);
					}

					return false;
				});
			});

			//相册选择
			$('.select_xc').click(function(){
				$('#network_pic').pic_dialog('show');	
				$('#network_pic').pic_dialog({para:{controller:'NetworkPic',method:'getPic'},size:12,page:1,img:'#img',input:'#pic',message:'message'});
				json.setImgSize('diseasesize');
			});
			
			//相册选择
			$('#disease_edit').on('click','#set',function(){
				$('#network_pic').pic_dialog('show');
				$('#network_pic').pic_dialog({editor:'#editor',para:{controller:'NetworkPic',method:'getPic'},size:12,page:1,message:'message'});
			});				

			if(!$.browser.msie){
				$('#network_pic').picDrag('message');
			}

			//返回
			$('#back').click(function(){
				if(para.department_id != undefined){
					self.disease({id:para.department_id});
				}else{
					self.disease();
				}
			});
			
		});
	}
	this.resertemplate = function(para){
		var self=this;
		$('#container').tpl('reser_manage/resertep_list',function(result){
			
			Back.PushChild('resertemplate',para);
			$('#grid').grid({
				size : 10,
				order : true,
				para : {controller:'ReserTemplate',method:'query'},
				check : true,
				field : [
				    {text:'科室',name:'department'},
					{text:'模板名称',name:'title',width:200},	
					{text:'时间',name:'plushtime',width:200},	
				    {text:'操作',name:'id',width:200,
				    	render:function(value){
				    		var str='<a id="'+value+'" class="button btn_del" href="javascript:void(0)" style="margin-left:3px;"><span>删除</span></a>';
				    		str+='<a class="button btn_edit" id="'+value+'" href="javascript:void(0)" style="margin-left:8px;"><span>编辑</span></a>';
				    		//str+='<a class="button btn_look" id="'+value+'" href="javascript:void(0)" style="margin-left:8px;"><span>查看详细</span></a>'; 
				    		return str;
				    	}
				    }
				]
			});
			//关联科室
			dd.cmd({controller:'DepartmentManager',method:'getDepartments'},function(result){
				
				var html='';
				if(result.statu){
					departments = result.data;
					html = '<option value="">请选择</option>';
					$.each(result.data,function(index,obj){
						html += '<option value="'+obj.id+'">'+obj.name+'</option>';
					});
					$('#department_id').html(html);
				}
			});
			//添加
			$('#add').click(function(){
				self.reservationEdit({method:'add',departments:departments});
			});
			//编辑
			$('#grid').on('click','.btn_edit',function(){
				$("#loading").addClass("loading");
				var id=$(this).attr("id");
				self.reservationEdit({id:id,method:'edit',departments:departments});
				
			});

			//刷新
			$("#refresh").click(function(){
				$('#grid').grid('reload');
			});
			//删除
			$("#grid").on('click','.btn_del',function(){
				var id=$(this).attr('id');
				if(window.confirm('真的要删除吗')){
					dd.cmd({controller:'ReserTemplate',method:'delete',id:id},function(re){
						if(re.statu){
							$('#message').message('删除成功!',function(){
								$('#grid').grid('reload');
							});
						}else{
							$('#message').message('删除失败!');
						}
						return false;
					});
				}
			});
			//批量删除
			$("#del").click(function(){
				var data=$("#grid").grid('getRows');
				if(data.length<=0){
					$('#message').message('请选择您要删除的选项!');
				}else{
					var ids=new Array();
					if(window.confirm("确定要删除吗？")){
						$.each(data,function(i,obj){
							ids[i]=obj.id;
						});
						dd.cmd({controller:'ReserTemplate',method:'delete',id:ids},function(re){
							if(re.statu){
								$('#message').message('删除成功!',function(){
									$('#grid').grid('reload');
								});
							}else{
								$('#message').message('删除失败!');
							}
						});
					}
				}
				return false;
			});
			//查询
			$('#qry').click(function(){
				var data = $('#frm_post').frmVal({});
				$('#grid').grid({qry_para:data});
			});
//			$('#back').click(function(){
//				resertemplate();
//			});

		});
	}
	//预约挂号编辑
	this.reservationEdit = function(para){
		var self = this;
		$('#order').tpl('reser_manage/reser_edit',function(result){
			Back.PushChild('reservationEdit',para);
			//关联科室
			var html='<option value="0">-请选择-</option>';
			$.each(para.departments,function(i,obj){
				html += '<option value="'+obj.id+'">'+obj.name+'</option>';
			});
			$('#department_id').html(html);
			
	
			if(para.method == 'add'){
				var post = {controller:'Reservation',method:'add'};
			}else{
				
				$('#addpage').css('display','block');
				$("#loading").removeClass("loading");
				
				$('#paibanbutton').hide();
				dd.cmd({controller:'ReserTemplate',method:'gettemple',id:para.id},function(re){
					if(re.statu){
						setSelectChecked("department_id",re.data.department_id);
						$("input[@type=radio][name=resertype][@value=re.data.department_i]").attr("checked",true);
						$('#temid').val(re.data.id);
						$('#temtype').val(re.data.type);
						maketable(re.data.type);
						dd.cmd({controller:'ReserTemplate',method:'gettemdetail',tem_id:re.data.id,type:re.data.type},function(ress){
							if(ress.stute){
								$.each(ress.date,function(i,val){
									var tdid=val.date+val.kind+'name';
									var showhtml='<ul class="doctorlists">';
										$.each(val.doctor_num,function(k,v){
											showhtml+='<li><span>'+v.name+'</span><span>'+v.num+'</span></li>';
										});
										showhtml+='</ul>';
										
										$('#'+tdid).html(showhtml);
									//console.log(tdid);
									
								});
								
							}
						});
						
						 
					}else{
						$('#message').message(re.msg);
					}
					
				});

			}
			$('#save').click(function(){
                $('#order_edit').frmPost(post,function(result){
                	if(result.statu){
						$('#message').message('操作成功!');
						self.reservation();
					}else{
						$('#message').message(result.msg);
					}
					return false;
				});
			});
			//返回
			$('#back').click(function(){
				self.resertemplate();
			});
		});
	}
	this.reser_detail = function(para){
		var self=this;
		

	        //$('#container').tpl('reser_manage/reserdetail_list',function(result1){
	        	//Back.PushChild('doctor_manager',para);
	        	
	        	
				var post = {controller:'Reservation',method:'query'};
				//alert(post);
				if(para != undefined){
					post.department_id = para.id;
				}

				
				self.cmd(gHttp,{controller:'DepartmentManager',method:'getDepartments'},function(ret){
					var html = '';
					if(ret.statu){
						departments = ret.data;
						html = '<option value="">全部</option>';
						$.each(ret.data,function(i,obj){
							html += '<option value="'+obj.id+'">'+obj.name+'</option>';
						});
						
						$('#department_id').html(html);
					}else{
						$('#message').message(ret.msg);
					}
					return false;
				});
				
//				$("#choose_time,#edits_time").on("click", function(){
//				    WdatePicker({ 
//				    	skin:'whyGreen',dateFmt:'yyyy-MM-dd',vel:'choose_time'
//				    });
//				});
				$('body').on('change', '#department_list',function() {
					if(this.value==""){return;}
					
					var theids=this.value;
					get_doctor(theids);
					 
					});
				
//				$(".searchform").Validform({
//					btnSubmit:"#submitform", 
//					ajaxurl:'/controller/?controller=Reservation&method=query',
//					ajaxPost:true,
//					callback:function(data){
//						//alert('ooo');
////						if(data.status=="y"){
////							setTimeout(function(){
////								$.Hidemsg(); //公用方法关闭信息提示框;显示方法是$.Showmsg("message goes here.");
////							},2000);
////						}
//					}
//				});
				
				$('body').on('click', '#datadel',function() {
					//chooseall('reservationtable');
					var data = chooseall('#reservationtable');
					var ids = [];
					//console.log(data);
					if(data.length <= 0){
						layer.msg('请选择需要删除的选项!', function(){					
						}); 
					}else{
						
						layer.confirm('真的要删除么？', {icon: 3, title:'提示'}, function(index){
						  
							$.each(data,function(i,obj){
								ids[i] = obj.value;
							});	
						    layer.close(index);
						

	

							self.cmd(gHttp,{controller:'Reservation',method:'delete',id:ids},function(ret){
								if(ret.statu){
									
									layer.msg('删除成功!', function(){					
									}); 
									troad('#reservationtable');
									$('.firstone').attr('checked', false);

								}else{
									
									layer.msg(ret.msg, function(){					
									}); 
									
								}
							});
						});
						
					}
					return false; 
					

					 
					});
				
				

					var resertable=$("#reservationtable").DataTable({
						
						bStateSave:false,
						serverSide: true,
						processing: true,
						searching: true,
						ajax:{
							'url':'/controller/?controller=Reservation&method=query',
							//'dataSrc': 'data',
							'type':'POST',
							
							'data': {
								'page':function(){
									var info=$("#reservationtable").DataTable().page.info();
									return info.page+1;
								},
								'size':function(){
									var info=$("#reservationtable").DataTable().page.info();
									return info.length;
								},

								
							},
							'dataType':'json',
							'dataSrc': function(json){
								
								return json.data;
								
							}
							


							
								
						},

						order: [[ 1, "desc" ]],
						//select: true,
						aoColumnDefs : [
							{sClass:'text-c',aTargets:[0]},{sClass:'text-c',aTargets:[1]},{sClass:'text-c',aTargets:[2]},{sClass:'text-c',aTargets:[3]},{sClass:'text-c',aTargets:[4]},{sClass:'text-c',aTargets:[6]},{sClass:'text-c',aTargets:[7]},{sClass:'text-c',aTargets:[8]},{sClass:'text-c',aTargets:[9]}
							],
	
						columns: [
						            {
						            	data : 'id',
						            	render : function (id, type, row) {
						            		return '<input type="checkbox" name="tr_'+id+'" id="tr_'+id+'" value="'+id+'">';
						            	},
						            	name: 'xuanze',
						            	orderable:false
						            },
						            { data: 'id'	
						            	},
						            { data: 'doctor',name:'doctor'},
						            { data: 'department',name:'department'},
						            { data: 'date',name:'date'},
						            { data: 'times',name:'times',orderable:false},
						            { data: 'along',name:'along' },
						            { data: 'mark',name:'mark' },
						            { data: 'state',name:'state',
						              render:function(id,type,row){
						            	  if(id=='0'){
						            		  return '<span class="label label-success radius">可预约</span>';
						            	  }else{
						            		  return '<span class="label label-warning radius">己停诊</span>';
						            	  }
						            	  
						              }
						            	},
						            {
									  
									  render : function(data, type, row){
										  var str = '';
										  str += '<a class="btn_cha" dataid="'+row.id+'" title="查看预约详情" href="javascript:;" style="text-decoration:none"><i class="Hui-iconfont"></i></a> <a class="btn_shen ml-5" dataid="'+row.id+'" title="申请加号" href="javascript:;" style="text-decoration:none"><i class="Hui-iconfont"></i></a> <a class="ml-5 btn_ting" dataid="'+row.id+'" title="停诊设置" href="javascript:;" style="text-decoration:none"><i class="Hui-iconfont"></i></a> <a title="修改排班" dataid="'+row.id+'" href="javascript:;" class="ml-5 editreser" style="text-decoration:none"><i class="Hui-iconfont"></i></a> <a title="删除" href="javascript:;" onclick="" dataid="'+row.id+'" class="ml-5 trush" style="text-decoration:none"><i class="Hui-iconfont"></i></a>';
								    	  return str;
									  },
									  orderable:false
									 }
						        ]

	
					
					});
					
					$('#reservationtable').on('draw.dt search.dt', function () {
						var info=$("#reservationtable").DataTable().page.info();
						$('#reservationtable_filter').hide();
						var nums=info.recordsDisplay;
						$('#totalnum').html('<strong>'+nums+'</strong>');
						
					});
					
					
					
					
					
					$('body').on('click','.reflash', function () {
						
						troad('#reservationtable');
						
					});
					
					$('body').on('click','.editreser', function () {
						var id=$(this).attr('dataid');
						
						
						layer.open({
							type:2,	
							area: ['900px', '500px'],
						    content: 'appointment-add.html',
						    success: function(layero,index){
						        layer.setTop(layero); 
						        var body = layer.getChildFrame('body', index);
						        var iframeWin = window[layero.find('iframe')[0]['name']];
						        //$(window.frames["iframeSon"].document).find(":text");
						        //console.log(body.html());
						      iframeWin.gReservation.reser_add({id:id});
						    }
						});
						
						
					});
					
					$('body').on('click','#submitform', function () {
						var table = $('#reservationtable').DataTable();
						var name=$.trim($('#serdoctor').val());
						var department=$.trim($("#department_id  option:selected").val());
						var starttime=$.trim($('#logmin').val());
						var endtime=$.trim($('#logmax').val());
						var thevalue=JSON.stringify({ "name":name, "department_id":department,"starttime":starttime,"endtime":endtime});
						 table.search(thevalue).draw();
						 
						
						//troad('#reservationtable');
						
					});
					
					$('#serdoctor, #logmin, #logmax, #department_id').on( 'keyup click change', function () {   // for text boxes
						var table = $('#reservationtable').DataTable();
						var name=$.trim($('#serdoctor').val()); // getting search input value
					    var department=$.trim($("#department_id  option:selected").val());
					    var starttime=$.trim($('#logmin').val());
						var endtime=$.trim($('#logmax').val());
						var thevalue=JSON.stringify({ "name":name, "department_id":department,"starttime":starttime,"endtime":endtime});
					    table.search(thevalue).draw();
					} );
					
					
					
					$('#reservationtable').on('click','.trush', function () {
						var id=$(this).attr('dataid');
						layer.confirm('确定要删除吗?', function(index){
							self.cmd(gHttp,{controller:'Reservation',method:'delete',id:id},function(re){
								if(re.statu){
									layer.msg('删除成功!');
									troad('#reservationtable');

								}else{
									layer.msg('删除失败!');
									//$('#message').message('删除失败!');
								}
								return false;
							});
						    
						    layer.close(index);
						});  
						

						
						
					});
					
					$('body').on('click','.addrecord', function () {
						layer.open({
							type:2,	
							area: ['900px', '500px'],
						    content: 'appointment-add.html',
						    success: function(layero,index){
						        layer.setTop(layero); 
						        var body = layer.getChildFrame('body', index);
						        var iframeWin = window[layero.find('iframe')[0]['name']];
						        //$(window.frames["iframeSon"].document).find(":text");
						        //console.log(body.html());
						      iframeWin.gReservation.reser_add();
						    }
						});
						
						
					});
					
					
					

					
					$('#reservationtable').on('click', '.btn_cha',function() {
						
						var id = $(this).attr('dataid');
						
						self.cmd(gHttp,{controller:'Reservation',method:'get',id:id},function(reos){
						if(reos.statu){
							
							//self.reser_patient({department_id:reos.data.department_id,doctor_id:reos.data.doctor_id,date:reos.data.date,start:reos.data.start,end:reos.data.end});
							layer.open({
								type:2,	
								area: ['900px', '500px'],
							    content: 'reservation-record.html',
							    success: function(layero,index){
							        layer.setTop(layero); 
							        var body = layer.getChildFrame('body', index);
							        var iframeWin = window[layero.find('iframe')[0]['name']];
							        //$(window.frames["iframeSon"].document).find(":text");
							        //console.log(body.html());
							      iframeWin.ReservationDetail.reser_patient({department_id:reos.data.department_id,doctor_id:reos.data.doctor_id,date:reos.data.date,start:reos.data.start,end:reos.data.end});
							    }
							}); 
						}
					});
						


						

						 
						});
					
					$('#reservationtable').on('click', '.btn_shen',function() {
						var id = $(this).attr('dataid');
						//self.cmd(gHttp,{controller:'Reservation',method:'get',id:id},function(reos){
							//if(reos.statu){
								
						
						layer.open({							
						    type: 2, 
						    content: 'position-add.html',
						    area: ['600px', '400px'],
						    success: function(layero,index){
						        var body = layer.getChildFrame('body', index);
						        var iframeWin = window[layero.find('iframe')[0]['name']];
						        iframeWin.ReservationDetail.reser_addnum({id:id})
						    }
						});
					});
					
//					$('#reservationtable').on('click', '.btn_shen',function() {
//						var id = $(this).attr('dataid');
//						//self.cmd(gHttp,{controller:'Reservation',method:'get',id:id},function(reos){
//							//if(reos.statu){
//								
//						
//						layer.open({							
//						    type: 2, 
//						    content: 'position-add.html',
//						    area: ['600px', '400px'],
//						    success: function(layero,index){
//						        var body = layer.getChildFrame('body', index);
//						        var iframeWin = window[layero.find('iframe')[0]['name']];
//						        iframeWin.ReservationDetail.reser_addnum({id:id})
//						    }
//						});
//					});
					
					$('#reservationtable').on('click', '.btn_ting',function() {
						var id = $(this).attr('dataid');
						
						layer.open({							
						    type: 1, 
						    content: '<p>是否修改该医生的可预约状态？</p>',
						    btn: ['确定', '取消'],
						    yes: function(index, layero){	
						    	
						    
						    	self.cmd(gHttp,{controller:'Reservation',method:'get',id:id},function(rets){
									if(rets.statu){
										
										var sthml='';
										
										self.cmd(gHttp,{controller:'ReservationDetail',method:'query',date:rets.data.date,department_id:rets.data.department_id,doctor_id:rets.data.doctor_id,start:rets.data.start,end:rets.data.end},function(result){
											if(result.ttl=='0'){
												layer.confirm('确定要停诊吗?', {icon: 3, title:'提示'}, function(index){
													   
												    
												    layer.close(index);
												}); 

											}else{
												
												layer.open({
													type: 1,
												    content: '该医生该天己有人预约，修改为停诊前是否要通知这些患者？',
												    btn: ['查看详情', '直接停诊'],
												   yes: function(index, layero){
												    	
												    	
														self.cmd(gHttp,{controller:'Reservation',method:'get',id:id},function(reos){
															if(reos.statu){
																
																
																layer.open({
																	type:2,	
																	area: ['900px', '500px'],
																    content: 'reservation-record.html',
																    success: function(layero,index){
																        layer.setTop(layero); 
																        var body = layer.getChildFrame('body', index);
																        var iframeWin = window[layero.find('iframe')[0]['name']];

																      iframeWin.ReservationDetail.reser_patient({department_id:reos.data.department_id,doctor_id:reos.data.doctor_id,date:reos.data.date,start:reos.data.start,end:reos.data.end});
																    }
																}); 
															}
														});
												    },
												    cancel: function(index, layero){
												    	self.cmd(gHttp,{controller:'Reservation',method:'setstop',id:id},function(reos){
										            		if(reos.statu){
										        				troad('#reservationtable');
										        				
										        				
										        				layer.closeAll();
										        				layer.msg('操作成功');
										            			
										            		}else{
										            			$('#message').message(reos.msg);
										            		}
										            	});	
												    }
												    
					
												});
												

											}
										});
	
										
										}
									
								});	
			 
						    },
						    cancel:function(index, layero){
						    	//alert('2');
						    	layer.close(index);  
						    }

						});
					});

		
	}
	
	this.reser_add=function(para){
		var self=this;
		
		self.cmd(gHttp,{controller:'DepartmentManager',method:'getDepartments'},function(ret){
		var html = '';
		if(ret.statu){
			departments = ret.data;
			html = '';
			$.each(ret.data,function(i,obj){
				html += '<option value="'+obj.id+'">'+obj.name+'</option>';
			});
			
			$('#department_list').html(html);
			
			if(para!=undefined){
				console.log(para);
				self.cmd(gHttp,{controller:'Reservation',method:'get',id:para.id},function(retdts){
					
					if(retdts.statu){
						$('#department_list').children("option").each(function(){  
				               var temp_value = $(this).val();
				              if(temp_value == retdts.data.department_id){  
				                    $(this).attr("selected","selected");  
				              } 
				              
				         }); 
						
						var thedepart=$("#department_list  option:selected").val();
						
						 self.get_doctor(thedepart);
						 
						 
								$('#editsdoctors_list').children("option").each(function(){  
						               var dotemp_value = $(this).val();
						              if(dotemp_value == retdts.data.doctor_id){
						            	 //console.log(retdts.data.doctor_id);
						                    $(this).attr("selected","selected");  
						              }  
						              
						         });
								 $('#edits_time').val(retdts.data.date);
									$('#timefir').val(retdts.data.start);
									$('#timesec').val(retdts.data.end);
									$('#edittotalnum').val(retdts.data.along);
									
									$('#'+retdts.data.time).iCheck('check'); 

					
						
					}
				});	
			}else{
				var thedepart=$("#department_list  option:selected").val();
				self.get_doctor(thedepart);
			}

				 
			 
			 
			 
			
		}else{
			//$('#message').message(ret.msg);
			layer.msg(ret.msg, function(){					
			}); 
		}
		return false;
	});

		
		$('body').on('change', '#department_list',function() {
			if(this.value==""){return;}

			var theids=this.value;
			self.get_doctor(theids);
			 
			});	
	}
	
	this.get_doctor=function(depid){
		
		self.cmd(gHttp,{controller:'DoctorManager',method:'getByDepartmentID',department_id:depid},function(retd){
			if(retd.statu){
				var list="";
				$.each(retd.data,function(n,m){
				list+='<option value="'+m.id+'">'+m.name+'</option>';	
				});
				
				$('.doctorlistsec').html(list);
				
			}else{
				//$('#message').message(retd.msg);
				layer.msg(retd.msg, function(){					
				}); 
			}
		})

}	
	
	this.reser_patient=function(para){
		var self=this;

	        //$('#container').tpl('reser_manage/reserpatient_list',function(result1){
	        	//Back.PushChild('reser_patient',para);
	        	//console.log(para);
				if(para != undefined){
					
					//var post = self.cmd(gHttp,{controller:'ReservationDetail',method:'query',date:para.date,department_id:para.department_id,doctor_id:para.doctor_id,start:para.start,end:para.end};
					
				var t=$("#reserverdetail").DataTable({
						
						bStateSave:false,
						serverSide: false,
						processing: true,
						ajax:{
							'url':'/controller/?controller=ReservationDetail&method=query',
							//'dataSrc': 'data',
							'type':'POST',
							'data': {
								
								'date':para.date,
								'department_id':para.department_id,
								'doctor_id':para.doctor_id,
								'starttime':para.start,
								'endtime':para.end								
							},
							'dataType':'json',
							'dataSrc': function(json){

								return json.data;
								
							}
							


							
								
						},
					       columnDefs: [ {
					            "searchable": false,
					            "orderable": false,
					            "targets": 2
					        } ],
						order: [[ 1, "desc" ]],
						columns: [
						            {
						            	data : 'id',
						            	render : function (id, type, row) {
						            		return '<input type="checkbox" name="tr_'+id+'" id="tr_'+id+'" value="'+id+'">';
						            	},
						            	name: 'xuanze',
						            	orderable:false
						            },
		                            { data: 'id',name:'id' },
						            { data: 'username',name:'username' },
						            { data: 'telephone',name:'telephone'},
						            { data: 'department',name:'department' },
						            { data: 'doctor',name:'doctor'},
						            { data: 'date',name:'date' },
						            { data: 'times',name:'times' },
						            { data: 'statu',name:'statu'},
						            {
									  data : 'id',
									  render : function(id, type, row){
										  var str = '';
										  str += '<a class="btn_cha" title="查看预约详情" href="javascript:;" style="text-decoration:none"><i class="Hui-iconfont"></i></a>';
								    	  return str;
									  },
									  orderable:false
									 }
						        ]
	
					
					});
				

					
					
					
					
				}else{
					var post = {controller:'ReservationDetail',method:'query'};
				}
				
				//alert(post);

				

				
	        	

	        	
				//批量删除
				$('#return_button').click(function(){

				});
				$("#refresh").click(function(){
					$('#grid').grid('reload');
				});
				$('#qry').click(function(){
					var data = $('#frm_post').frmVal({});
					$('#grid').grid({qry_para:data});
				});
			
			
			
			
		//});
		
		
	}
	this.reser_addnum= function(para){
		var self=this;
		self.cmd(gHttp,{controller:'Reservation',method:'get',id:para.id},function(reos){
		if(reos.statu){
			$('#departmentcontent').html(reos.data.department);
			$('#doctorname').html(reos.data.doctor);
			$('#datacontent').html(reos.data.date);
			$('#timecontent').html(reos.data.resertime);
			$('#alongnum').attr("placeholder",reos.data.along);
			$('#dataid').val(reos.data.id);
			var timetype="";
			switch (reos.data.time){
			case 'mon':
			timetype='上午';
			break;
			case 'aft':
			timetype='下午';
			break;
			default:
			timetype='晚上';
			break;
	
			}
			$('#timetype').html(timetype);
			
		}
		});
		
		
		
	}
	
	this.reser_patient_detail= function(para){
		var self=this;
		//Back.PushChild('doctor_manager',para);
			
        $('#container').tpl('reser_manage/reser_patient_detail',function(result1){
        	Back.PushChild('reser_patient',para);
        	if(para != undefined){
        		dd.cmd({controller:'ReservationDetail',method:'get',id:para.id},function(ret){
        			if(ret.statu){
        				$('#name').val(ret.data.username);
        				$('#tel').val(ret.data.telephone);
        				$('#shengfengzheng').val(ret.data.card);
        				$('#department').val(ret.data.department);
        				$('#doctor').val(ret.data.doctor);
        				$('#dates').val(ret.data.date);
        				$('#times').val(ret.data.times);
        				$('#stute').val(ret.data.statu);
        				
        				
        			}else{
        				$('#message').message(ret.msg);
        			}
        			
        		});
        		
        	}
			$('#back').click(function(){
				self.reser_patient();
			});
        	
        	
        	
        	});
		
	}
	
	
};
