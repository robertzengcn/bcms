<?php

/*
 * 登陆页面模块
 * */
if (!defined('Boyiweb')) {
	die('Illegal Access');
}

//ini_set("display_errors", "0");
include_once ABSPATH.'/mod/Mod.php';

class Register extends Mod{
	private $HMAKEY='Vb4!PLCzCW';
	private $boyiurl="http://www.boyicms.com/interface/hma/HmaAccountInterface.php";

	public function __construct() {
		parent::__construct();
		$this->excute();
	}
	
	/**
	 *
	 *登录类方法
	 */
	public function index() {
		
        session_start();
		$_SESSION['token']=md5(time().rand(1,999));//产生一个随机数防止域外提交	
		$this->smarty->assign("token", $_SESSION['token']);
		$this->smarty->display( 'register/index'.SUBFIX);
	}
	public function register(){
		session_start();
		if(!isset($_REQUEST['verify'])||strtolower($_SESSION['verify'])!=strtolower($_REQUEST['verify'])){
			$array = array('status'=>false,'msg'=>'验证码错误','code'=>10001,'data'=>null);
			$_SESSION['verify']=rand(1,100);//随机生成一个验证码覆盖原来的
			echo json_encode($array);
			exit();
		}
		
		if(!isset($_REQUEST['token'])||$_SESSION['token']!=$_REQUEST['token']){
			$array = array('status'=>false,'msg'=>'非法跨域请求','code'=>10002,'data'=>null);
			echo json_encode($array);
			exit();
		}
		if(!isset($_REQUEST['auth_code'])||md5($_REQUEST['auth_code'])!=$_SESSION['MOBILE_AUTH_CODE']){
			$array = array('status'=>false,'msg'=>'auth_code不正确','code'=>10005,'data'=>null);
			echo json_encode($array);
			exit();
		}
		
		if(!isset($_REQUEST['mobile'])||!strlen($_REQUEST['mobile'])>1){
			$array = array('status'=>false,'msg'=>'缺少mobile参数','code'=>10003,'data'=>null);
			echo json_encode($array);
			exit();
		}
		if(!isset($_REQUEST['password'])||!strlen($_REQUEST['password'])>1){
			$array = array('status'=>false,'msg'=>'缺少password参数','code'=>10004,'data'=>null);
			echo json_encode($array);
			exit();
		}
		$memberser=new MemberService();
		
		$result=$memberser->registmember($_REQUEST['mobile'],$_REQUEST['password']);

		
		if($result->statu){
			$array = array('status'=>true,'msg'=>null,'code'=>0,'data'=>null);
			echo json_encode($array);
			exit();
		}else{
			
			$array = array('status'=>false,'msg'=>$result->msg,'code'=>$result->code,'data'=>null);
			echo json_encode($array);
			exit();
		}
		
		
	}
	/*
	 * 生成一个token
	 * */
	
	public function gettoken(){
		if(!session_id()) session_start();
		$_SESSION['token']=md5(time().rand(1,999));//产生一个随机数防止域外提交
		$array = array('status'=>true,'msg'=>null,'code'=>null,'data'=>$_SESSION['token']);
		echo json_encode($array);
	}
	
	public function sendcode(){
		if(!session_id()) session_start();
		if($_SESSION['token']!=$_REQUEST['token']){
			$array = array('statu'=>false,'msg'=>'非法跨域请求','code'=>10002,'data'=>null);
			echo json_encode($array);
			exit();
		}
		$phonenum=isset($_REQUEST['mobile'])&&strlen($_REQUEST['mobile'])>0?$_REQUEST['mobile']:null;
		 
		if(preg_match("/^13[0-9]{1}[0-9]{8}$|15[0-9]{1}[0-9]{8}$|18[0-9]{1}[0-9]{8}$|17[0-9]{1}[0-9]{8}/",$phonenum)){ //验证通过
			//$HMAKEY='Vb4!PLCzCW';
		    		//$HMAKEY='Vb4!PLCzCW';
    		$url=$this->boyiurl."?type=sendcode";//请求总控发送验证码
    		$post_data=array(
    				'mobile'=>$phonenum,
    				'hmkey'=>md5( $this->HMAKEY . date('Y-m-d') ),
    				'website'=>NETADDRESS,
    				   				    				   		
    		);
    		$fresult=$this->send_post($url,$post_data);
    		
    		$result=json_decode($fresult,true);
    		
    		if($result['res']==0){
    			echo json_encode(array('stute'=>true,'msg'=>null,'code'=>0,'data'=>null));    			
    		}else{
    			echo json_encode(array('stute'=>false,'msg'=>$result['message'],'code'=>0,'data'=>null));
    		}  
					

		}else{
			//手机号码格式不对
			echo json_encode(array('stute'=>false,'msg'=>'手机号码不正确','code'=>0,'data'=>null));
		}
		exit();
	}
	
	public function registernocaptcha(){
		if(!session_id()) session_start();
	
		if(!isset($_REQUEST['token'])||$_SESSION['token']!=$_REQUEST['token']){
			$array = array('status'=>false,'msg'=>'非法跨域请求','code'=>10002,'data'=>null);
			echo json_encode($array);
			exit();
		}
		if(!isset($_REQUEST['auth_code'])||md5($_REQUEST['auth_code'])!=$_SESSION['MOBILE_AUTH_CODE']){
			$array = array('status'=>false,'msg'=>'短信验证码不正确','code'=>10005,'data'=>null);
			echo json_encode($array);
			exit();
		}
	
		if(!isset($_REQUEST['mobile'])||!strlen($_REQUEST['mobile'])>1){
			$array = array('status'=>false,'msg'=>'缺少mobile参数','code'=>10003,'data'=>null);
			echo json_encode($array);
			exit();
		}
		if(!isset($_REQUEST['password'])||!strlen($_REQUEST['password'])>1){
			$array = array('status'=>false,'msg'=>'缺少password参数','code'=>10004,'data'=>null);
			echo json_encode($array);
			exit();
		}
		$memberser=new MemberService();
		

		$result=$memberser->registmember($_REQUEST);
	
	
		if($result->statu){
			$array = array('status'=>true,'msg'=>null,'code'=>0,'data'=>null);
			echo json_encode($array);
			exit();
		}else{
				
			$array = array('status'=>false,'msg'=>$result->msg,'code'=>$result->code,'data'=>null);
			echo json_encode($array);
			exit();
		}		
	}
	
	/*
	 * 找回密码
	 * */
	public function findbackpass(){
		
		
	}
	
	/*
	 * 验证短信验证码找回密码
	 * */
	public function valimesscode(){
		if(!session_id()) session_start();
		if(!isset($_REQUEST['mobile'])||strlen($_REQUEST['mobile'])<1){
		       $this->msgPut(false,1,'手机号为空',null);
		}
		if(!isset($_REQUEST['verify'])||strlen($_REQUEST['verify'])<1){
			$this->msgPut(false,2,'图像验证码为空',null);
		}
		if(strtolower($_REQUEST['verify'])!=strtolower($_SESSION['verify'])){
			//$_SESSION['verify']=rand(1000,9999);//产生一个随机数覆盖原来的验证码
			$this->msgPut(false,3,'图像验证码错误',$_SESSION['verify']);
		}

		if(!isset($_REQUEST['tcode'])||strlen($_REQUEST['tcode'])<1){
			$tcode=$_REQUEST['tcode'];
			$this->msgPut(false,4,'短信验证码为空',null);
		}
		if(!isset($_REQUEST['tcode'])||strlen($_REQUEST['tcode'])<1){
			$tcode=$_REQUEST['tcode'];
			$this->msgPut(false,5,'短信验证码为空',null);
		}
		if(!isset($_REQUEST['userpassword'])||strlen($_REQUEST['userpassword'])<1){
			$this->msgPut(false,6,'新密码为空',null);
		}

		if(!isset($_REQUEST['twopassword'])||$_REQUEST['twopassword']!=$_REQUEST['userpassword']){
			$this->msgPut(false,7,'两次密码不一致',null);
		}
		
		$memberser=new MemberService();
	
		$result=$memberser->validmobilemess($_REQUEST['mobile'],$_REQUEST['tcode'],$_REQUEST['userpassword']);
		if($result->statu){
			$this->msgPut(true,0,null,null);
		}else{
			$this->msgPut(false,8,$result->msg,null);
		}
		
		
		
	}
	
	
	
}
new Register();