<?php
/**
 * 
 * cms预约接口
 * @author Administrator
 * @version v1.0
 * @example 该接口在进行预约后,由总控中心发起预约接口
 */
include './common.class.php';

class ReservationHwibsc extends common {
	
	public $posts = array();
	

	
	private $params = array(
		'domain'      	   => array('check'=>true,'info'=>'通信域名'),
		'reservation_id'   => array('check'=>true,'info'=>'总控预约ID'),
		'sign'        	   => array('check'=>true,'info'=>'通信加密字符串'),//false要修改
		'time'        	   => array('check'=>true,'info'=>'通信加密时间戳'),//false要修改
		'time_id' 	       => array('check'=>true,'info'=>'预约时间点ID'),
	    'time_field' 	       => array('check'=>true,'info'=>'预约具体时间'),
		'username'     	   => array('check'=>true,'info'=>'预约人姓名'),
		'age' 	           => array('check'=>true,'info'=>'年龄'),
		'sex' 		  	   => array('check'=>true,'info'=>'性别'),
		'telephone' 	   => array('check'=>true,'info'=>'联系电话'),
		'card'			   => array('check'=>false,'info'=>'预约人身份证号'),
		'email'			   => array('check'=>false,'info'=>'电子邮箱'),
		'address'   	   => array('check'=>false,'info'=>'联系地址'),
		'ill' 	  		   => array('check'=>false,'info'=>'预约留言'),
	);
	
	//构造函数
	public function __construct() {
		parent::__construct();
		$this->voluation();
		parent::signCheck();    
		//这里暂时注释，上线时开启
		$this->queryRes();
		parent::msgPut(true, '预约成功!' , null );
	}
	
	//查询time_id值是否正确
	private function queryRes() {
		
		

		
		new ReservationService();
		$find = R::findOne('reservation','id = '.$this->posts['time_id'].' and state=0');
// 		print_r($find);
// 		exit();
		
		if( is_object( $find ) ) {
			if( ($find->along-$find->mark) < 1 ) {
				parent::msgPut(4, '该预约时间段已经无号了', null);
			}else{
				$this->runRes( $find );
			}
		}else{
			parent::msgPut(3, 'time_id对应的预约信息不存在', null);
		}
	}
	
	//实际预约功能
	private function runRes( $resInfo ) {

		
// 		$reservationDetail->doctor_id=$resInfo->doctor_id;
// 		$reservationDetail->department_id=$resInfo->department_id;
 		$resInfo->dateform=date('Y-m-d',$resInfo->date);
		//print_r($reservationDetail->dateform.' '.$this->posts['time_field']);
		//exit();
			
		$resInfo->times=strtotime($resInfo->dateform.' '.$this->posts['time_field']);
// 		$reservationDetail->username=$_REQUEST['name'];
// 		$reservationDetail->telephone=$_REQUEST['hometel'];
// 		//$reservationDetail->card=$_REQUEST['card'];
// 		$reservationDetail->statu='待约';
		
		
		
		#.更新预约表信息(reservationdetail)
		//$sql = "UPDATE `reservationdetail` SET `statu`='已约',username='{$this->posts['username']}',telephone='{$this->posts['telephone']}' WHERE `id`={$this->posts['time_id']};";
		//R::exec($sql);
		#.增加预约用户信息
		//$date = date('Y',$resInfo->date);
		
		
// 		$time = strtotime($resInfo->date.''.$this->posts['time_field']);
// 		print_r($this->posts['time_field']);
// 		exit();
		
      //$ressql="INSERT INTO `reservationdetail`(`department_id`,`doctor_id`,`date`,`times`,`statu`,`username`,`telephone`,`card`) VALUES ($resInfo->department_id,$resInfo->doctor_id,$resInfo->date,$resInfo->times,'待约','{$this->posts['username']}','{$this->posts['telephone']}','{$this->posts['card']}')";
       
      $ressql="INSERT INTO `reservationdetail`(`department_id`,`doctor_id`,`date`,`times`,`statu`,`username`,`telephone`,`card`) VALUES (:department_id,:doctor_id,:date,:times,'待约',:username,:telephone,:card)";
       $resarray=array('department_id'=>$resInfo->department_id,
       		'doctor_id'=>$resInfo->doctor_id,
       		'date'=>$resInfo->date,
       		'times'=>$resInfo->times,
       		'username'=>$this->posts['username'],
       		'telephone'=>$this->posts['telephone'],
       		'card'=>$this->posts['card']
       );
       
       R::exec($ressql,$resarray);
       
// 		$sql = "INSERT INTO `reseruser` (`name`,`sex`,`age`,`date`,`time`,`address`,`hometel`,`email`,`ill`,`reservation_id`,`reservation_fid`) VALUES (
// 			'{$this->posts['username']}','{$this->posts['sex']}','{$this->posts['age']}',
// 			$resInfo->date,$resInfo->times,'{$this->posts['address']}','{$this->posts['telephone']}','{$this->posts['email']}',
// 			'{$this->posts['ill']}','{$this->posts['reservation_id']}','{$this->posts['time_id']}'
// 		)";
		
		$sql = "INSERT INTO `reseruser` (`name`,`sex`,`age`,`date`,`time`,`address`,`hometel`,`email`,`ill`,`reservation_id`,`reservation_fid`) VALUES (
		:name,:sex,:age,
		:date,:time,:address,:hometel,:email,
		:ill,:reservation_id,:reservation_fid
		)";
		$arrresuser=array('name'=>$this->posts['username'],
				'sex'=>$this->posts['sex'],
				'age'=>$this->posts['age'],
				'date'=>$resInfo->date,
				'time'=>$resInfo->times,
				'address'=>$this->posts['address'],
				'hometel'=>$this->posts['telephone'],
				'email'=>$this->posts['email'],
				'ill'=>$this->posts['ill'],
				'reservation_id'=>$this->posts['reservation_id'],
				'reservation_fid'=>$this->posts['time_id']				
		);
		
		
		
		R::exec($sql,$arrresuser);
	}
	
	private function voluation() {
		
// 		$filename=time();
		
// 		$apk_url = dirname(__FILE__) . "/oldfile_".$filename.".txt";
		
		
// 		$myfile = fopen( $apk_url, "w") or die("Unable to open file!");
// 		$txt = date('Y-m-d H:i:s',time());
		
// 		fwrite($myfile, $txt);
// 		$s = print_r($_REQUEST, true);
// 		fwrite($myfile, $s);
// 		fclose($myfile);
		foreach ( $this->params as $key => $value ) {
			if( isset( $_REQUEST[$key] ) && $_REQUEST[$key] != '' ) {
				$this->posts[$key] = trim( $_REQUEST[$key] );
			}else{
				if( $value['check'] === true ) {
					parent::msgPut(0, '参数缺失：'.$value['info'].':'.$key, null);
				}else{
					$this->posts[$key] = '';
				}
			}
		}
	}
	
}
new ReservationHwibsc();